"use strict";(self.webpackChunkcln_plugin_tutorial=self.webpackChunkcln_plugin_tutorial||[]).push([[447],{2345:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"rust-tutorial/life-cycle","title":"Life Cycle","description":"1) Plugin launches","source":"@site/docs/rust-tutorial/life-cycle.md","sourceDirName":"rust-tutorial","slug":"/rust-tutorial/life-cycle","permalink":"/cln-plugin-tutorial/rust-tutorial/life-cycle","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Life Cycle","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Background","permalink":"/cln-plugin-tutorial/rust-tutorial/background"},"next":{"title":"RPC Methods","permalink":"/cln-plugin-tutorial/rust-tutorial/rpc-methods"}}');var s=i(4848),l=i(8453);const o={title:"Life Cycle",sidebar_position:3},r="Plugin Life Cycle",a={},c=[{value:"1) Plugin launches",id:"1-plugin-launches",level:2},{value:"2) The <code>getmanifest</code> method is called",id:"2-the-getmanifest-method-is-called",level:2},{value:"3) The <code>init</code> method is called",id:"3-the-init-method-is-called",level:2},{value:"4) The plugin is now running normally",id:"4-the-plugin-is-now-running-normally",level:2}];function d(n){const e={code:"code",h1:"h1",h2:"h2",header:"header",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"plugin-life-cycle",children:"Plugin Life Cycle"})}),"\n",(0,s.jsx)(e.h2,{id:"1-plugin-launches",children:"1) Plugin launches"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Plugin is started by CLN in one of two ways: at CLN startup, or dynamically once CLN is already running.","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["At startup:","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Via a command line option: ",(0,s.jsx)(e.code,{children:"lightningd --plugin=/path/to/plugin1 --plugin=path/to/plugin2"})]}),"\n",(0,s.jsxs)(e.li,{children:["Via an option in the config file: ",(0,s.jsx)(e.code,{children:"plugin=/path/to/plugin"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["Dynamically:","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Via ",(0,s.jsx)(e.code,{children:"lightning-cli plugin start /path/to/plugin [options]"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.h2,{id:"2-the-getmanifest-method-is-called",children:["2) The ",(0,s.jsx)(e.code,{children:"getmanifest"})," method is called"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["CLN calls plugin\u2019s ",(0,s.jsx)(e.code,{children:"getmanifest"})," JSON-RPC method"]}),"\n",(0,s.jsx)(e.li,{children:"Plugin responds with a manifest where everything the plugin needs is registered with CLN, including options, hooks, rpc methods, and notifications."}),"\n",(0,s.jsx)(e.li,{children:"During startup, a plugin must respond within 60 seconds or it is killed."}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"The plugin's response will look something like this:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "options": [\n    {\n      "name": "greeting",\n      "type": "string",\n      "default": "World",\n      "description": "What name should I call you?",\n      "deprecated": false\n    }\n  ],\n  "rpcmethods": [\n    {\n      "name": "hello",\n      "usage": "[name]",\n      "description": "Returns a personalized greeting for {greeting} (set via options)."\n    },\n    {\n      "name": "gettime",\n      "usage": "",\n      "description": "Returns the current time in {timezone}",\n      "long_description": "Returns the current time in the timezone that is given as the only parameter.\\nThis description may be quite long and is allowed to span multiple lines.",\n      "deprecated": false\n    }\n  ],\n  "subscriptions": [\n    "connect",\n    "disconnect"\n  ],\n  "hooks": [\n    { "name": "openchannel", "before": ["another_plugin"] },\n    { "name": "htlc_accepted" }\n  ],\n  "featurebits": {\n    "node": "D0000000",\n    "channel": "D0000000",\n    "init": "0E000000",\n    "invoice": "00AD0000"\n  },\n  "notifications": [\n    {\n\t  "method": "mycustomnotification"\n\t}\n  ],\n  "nonnumericids": true,\n  "dynamic": true\n}\n'})}),"\n",(0,s.jsxs)(e.h2,{id:"3-the-init-method-is-called",children:["3) The ",(0,s.jsx)(e.code,{children:"init"})," method is called"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["CLN parses plugin options and passes them back by calling the plugin\u2019s ",(0,s.jsx)(e.code,{children:"init"})," method. This is also the signal that ",(0,s.jsx)(e.code,{children:"lightningd"}),"\u2019s JSON-RPC over Unix Socket is now up and ready to receive incoming requests from the plugin."]}),"\n",(0,s.jsx)(e.li,{children:"The request will look something like this:"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n  "options": {\n    "greeting": "World",\n\t"number": [0]\n  },\n  "configuration": {\n    "lightning-dir": "/home/user/.lightning/testnet",\n    "rpc-file": "lightning-rpc",\n    "startup": true,\n    "network": "testnet",\n    "feature_set": {\n        "init": "02aaa2",\n        "node": "8000000002aaa2",\n        "channel": "",\n        "invoice": "028200"\n    },\n    "proxy": {\n        "type": "ipv4",\n        "address": "127.0.0.1",\n        "port": 9050\n    },\n    "torv3-enabled": true,\n    "always_use_proxy": false\n  }\n}\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["The plugin sends a success response.","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"The plugin can optionally send a response at this point indicating that it\u2019s disabled."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["This response must occur within a certain timeout:","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"During startup, a plugin must respond within 60 seconds or it is killed."}),"\n",(0,s.jsx)(e.li,{children:"Plugins launched dynamically must respond to both getmanifest and init within 60 seconds or they are killed."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"4-the-plugin-is-now-running-normally",children:"4) The plugin is now running normally"}),"\n",(0,s.jsx)(e.p,{children:"Now your plugin can do stuff!"}),"\n",(0,s.jsx)(e.h1,{id:"exercise-build-a-bare-minimum-plugin-that-conforms-to-the-above-requirements",children:"Exercise: Build a bare minimum plugin that conforms to the above requirements"}),"\n",(0,s.jsxs)(e.p,{children:["If you click on ",(0,s.jsx)(e.code,{children:"rust-plugin/src/main.rs"})," in the file tree to your left, you will see a basic CLN plugin written in Rust. It doesn't do much, yet. It pretty much just runs. We'll add more to it as we work through this tutorial."]}),"\n",(0,s.jsx)(e.p,{children:"Here it is:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"//! This is a test plugin used to verify that we can compile and run\n//! plugins using the Rust API against Core Lightning.\n#[macro_use]\nextern crate serde_json;\nuse anyhow::anyhow;\nuse cln_plugin::{options, Builder, Error, Plugin};\nuse tokio;\n#[tokio::main]\nasync fn main() -> Result<(), anyhow::Error> {\n    let state = ();\n\n    if let Some(plugin) = Builder::new(tokio::io::stdin(), tokio::io::stdout())\n        .dynamic()\n        .start(state)\n        .await?\n    {\n        plugin.join().await\n    } else {\n        Ok(())\n    }\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"To test, open a shell and enter the following commands:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"mkdir -p ~/.bitcoin\nsource startup_regtest.sh\nstart_ln\n"})}),"\n",(0,s.jsxs)(e.p,{children:["These three commands will launch ",(0,s.jsx)(e.code,{children:"bitcoind"})," in regtest mode and attach two LN nodes to it."]}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"Remember these three commands."})," If your Repl freezes or if you need to leave your Repl and come back, you will need to enter these three commands into the shell again to get everything running again."]}),"\n",(0,s.jsx)(e.p,{children:"You may see an error message like this:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"error code: -4\nerror message:\nWallet file verification failed. SQLiteDatabase: Unable to obtain an exclusive lock on the database, is it being used by another instance of Bitcoin Core?\n"})}),"\n",(0,s.jsx)(e.p,{children:"This is normal; you may safely ignore it."}),"\n",(0,s.jsx)(e.p,{children:"Now, let's verify that everything is working:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"l1-cli getinfo\n"})}),"\n",(0,s.jsx)(e.p,{children:"You should see an output like this:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n   "id": "03dd398e70215a7bdecfcd62bf367d8c0deef7dd8e5241092790d15a23e5506b12",\n   "alias": "SILENTFELONY",\n   "color": "03dd39",\n   "num_peers": 0,\n   "num_pending_channels": 0,\n   "num_active_channels": 0,\n   "num_inactive_channels": 0,\n   "address": [],\n   "binding": [\n      {\n         "type": "ipv4",\n         "address": "127.0.0.1",\n         "port": 7171\n      }\n   ],\n   "version": "v0.12.1",\n   "blockheight": 1,\n   "network": "regtest",\n   "fees_collected_msat": 0,\n   "lightning-dir": "/tmp/l1-regtest/regtest",\n   "our_features": {\n      "init": "08a000080269a2",\n      "node": "88a000080269a2",\n      "channel": "",\n      "invoice": "02000000024100"\n   }\n}\n'})}),"\n",(0,s.jsxs)(e.p,{children:["Hooray! We have a Lightning node with a cool alias. You can enter the same commands on Node 2 by entering ",(0,s.jsx)(e.code,{children:"l2"})," instead of ",(0,s.jsx)(e.code,{children:"l1"}),"."]}),"\n",(0,s.jsx)(e.p,{children:"Now build your plugin:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sh",children:"cd rust-plugin\ncargo build\n"})}),"\n",(0,s.jsx)(e.p,{children:"When the build finishes, start your plugin:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sh",children:"l1-cli plugin start $(pwd)/target/debug/rust-plugin\n"})}),"\n",(0,s.jsx)(e.p,{children:"This will launch your plugin on Node #1. You should see a list of running plugins with your rust plugin as the last entry in the list."}),"\n",(0,s.jsx)(e.p,{children:"Now do:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{children:"l1-log\n"})}),"\n",(0,s.jsxs)(e.p,{children:["This will display Node #1's logfile. If you scroll to the bottom of the pager (shift + ",(0,s.jsx)(e.code,{children:"G"}),"), you should see a message from plugin-manager saying your plugin was started. Presing ",(0,s.jsx)(e.code,{children:"g"})," will bring you back to the top of the logfile."]}),"\n",(0,s.jsxs)(e.p,{children:["Press ",(0,s.jsx)(e.code,{children:"q"})," to return to the shell."]}),"\n",(0,s.jsxs)(e.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(e.li,{className:"task-list-item",children:[(0,s.jsx)(e.input,{type:"checkbox",disabled:!0})," ","Launch a Rust plugin with a message on init success, and find success message in the log."]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},8453:(n,e,i)=>{i.d(e,{R:()=>o,x:()=>r});var t=i(6540);const s={},l=t.createContext(s);function o(n){const e=t.useContext(l);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:o(n.components),t.createElement(l.Provider,{value:e},n.children)}}}]);